<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Management</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <style>
        .form-check-input {
            border: solid 1px black;
        }
        button {
            width: 100%;
        }
        .username_c {
            text-transform: capitalize;
            margin: -2px 0px 5px 0px;
        }
        .text_date {
            font-size: 12px;
        }
        input, textarea, select {
            border: 0.2px solid rgb(166, 166, 166) !important;
        }
                /* Alert styles */
        .alert {
            position: fixed;
            top: 20px;
            font-size: 12px;
            width: 100% !important;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1050; /* Ensure it's above other content */
            width: auto;
            max-width: 60%;
        }
        .completed {
            text-decoration: line-through;
            color: gray;
        }
        .hidden {
            display: none;
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getDatabase, ref, set, get, remove, onValue } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCNGOAnTyQ-z91is5nku_vKQMIXMsjH3sg",
            authDomain: "ttaskk-a50e4.firebaseapp.com",
            databaseURL: "https://ttaskk-a50e4-default-rtdb.firebaseio.com/",
            projectId: "ttaskk-a50e4",
            storageBucket: "ttaskk-a50e4.appspot.com",
            messagingSenderId: "213200371465",
            appId: "1:213200371465:web:2cee76953abdc5d8049dd8",
            measurementId: "G-8J99HLPT61"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);
        const firestore = getFirestore(app);
        let editingTaskId = null;
        let editingTaskUsername = ''; // Store the username of the task being edited

        // Sanitize input to prevent XSS
        function sanitizeInput(input) {
            const temp = document.createElement('div');
            temp.textContent = input;
            return temp.innerHTML;
        }

        // Authentication Functions
        function login(email, password) {
            signInWithEmailAndPassword(auth, email, password)
                .then(() => {
                    showAlert('Logged in successfully!');
                    document.getElementById('loginForm').reset();
                    toggleTaskManager(true);
                })
                .catch((error) => {
                    showAlert(error.message);
                });
        }

        function logout() {
            signOut(auth).then(() => {
                showAlert('Logged out successfully!');
                toggleTaskManager(false);
            }).catch((error) => {
                showAlert(error.message);
            });
        }

        function toggleTaskManager(isLoggedIn) {
            document.getElementById('taskManager').classList.toggle('hidden', !isLoggedIn);
        }

        async function getUserRole(uid) {
            const docRef = doc(firestore, 'users-uid', uid);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                return docSnap.data().role; // Assuming the role field exists
            } else {
                console.error("No such document!");
                return null;
            }
        }

        // Redirect based on user role
        async function redirectUserBasedOnRole() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const role = await getUserRole(user.uid);
                    if (role) {
                        if (role === 'User') {
                            window.location.href = 'taskuser.html'; // Redirect to task user page for User
                        } else if (role === 'Admin') {
                            toggleTaskManager(true); // Allow access for Admin
                        } else {
                            console.error("Role not recognized!");
                        }
                    } else {
                        console.error("Role not found.");
                    }
                } else {
                    window.location.href = 'login.html'; // Redirect if not authenticated
                }
            });
        }

        function writeTask(username, text, date) {
            const taskId = editingTaskId || Date.now();
            set(ref(database, 'tasks/' + taskId), {
                username: sanitizeInput(username),
                text: sanitizeInput(text),
                status: false,
                date: date
            });
            editingTaskId = null; // Reset editing task ID after saving
        }

        function updateTaskStatus(taskId, status) {
            const taskRef = ref(database, 'tasks/' + taskId);
            get(taskRef).then(snapshot => {
                if (snapshot.exists()) {
                    const taskData = snapshot.val();
                    set(taskRef, {
                        username: taskData.username,
                        text: taskData.text,
                        status: status,
                        date: taskData.date
                    });
                }
            }).catch((error) => {
                console.error("Error retrieving task: ", error);
            });
        }

        function displayTask(username, text, taskId, status, date) {
            const tasksList = document.getElementById('tasks-list');
            const taskItem = document.createElement('div');
            taskItem.classList.add('mb-3', 'p-3', 'border', 'rounded', 'bg-light');
            taskItem.innerHTML = `
                <div class="card-body">
                    <h5 class="card-title d-flex justify-content-between align-items-center">
                        <span class="username_c">${username}</span>
                    </h5>
                    <div class="d-flex align-items-between mb-2">
                        <input type="checkbox" class="form-check-input me-2" aria-label="Checkbox for task" data-id="${taskId}" ${status ? 'checked' : ''}>
                        <p class="mb-0 ${status ? 'completed' : ''}">${text}</p>
                    </div>
                    <div class="mb-2 text-muted text_date">Date: ${new Date(date).toLocaleDateString()}</div>
                    <div class="d-flex justify-content-end">
                        <button class="btn btn-primary btn-sm me-1 edit-btn" data-id="${taskId}" data-text="${text}" data-username="${username}" data-bs-toggle="modal" data-bs-target="#editTaskModal">Edit</button>
                        <button class="btn btn-danger btn-sm delete-btn" data-id="${taskId}">Delete</button>
                    </div>
                </div>
            `;
            tasksList.appendChild(taskItem);

            taskItem.querySelector('input[type="checkbox"]').addEventListener('change', function() {
                const isChecked = this.checked;
                if (isChecked) {
                    taskItem.querySelector('p').classList.add('completed');
                } else {
                    taskItem.querySelector('p').classList.remove('completed');
                }
                updateTaskStatus(taskId, isChecked);
            });
        }

        async function loadUsernames() {
            const usersCollection = collection(firestore, 'users-uid');
            const userDocs = await getDocs(usersCollection);
            const usernameSelect = document.getElementById('usernameSelect');
            const filterSelect = document.getElementById('filterSelect');
            usernameSelect.innerHTML = '';
            filterSelect.innerHTML = '<option value="">All Users</option>';

            userDocs.forEach(doc => {
                const data = doc.data();
                const option = document.createElement('option');
                option.value = data.username;
                option.textContent = data.username;
                usernameSelect.appendChild(option);

                const filterOption = document.createElement('option');
                filterOption.value = data.username;
                filterOption.textContent = data.username;
                filterSelect.appendChild(filterOption);
            });
        }

        function loadTasks(filterUsername = '') {
            const tasksRef = ref(database, 'tasks/');
            onValue(tasksRef, (snapshot) => {
                const tasksList = document.getElementById('tasks-list');
                tasksList.innerHTML = '';
                if (snapshot.exists()) {
                    const tasks = snapshot.val();
                    for (const taskId in tasks) {
                        const { username, text, status, date } = tasks[taskId];
                        if (filterUsername === '' || username === filterUsername) {
                            displayTask(username, text, taskId, status, date);
                        }
                    }
                } else {
                    console.log("No tasks available");
                }
            });
        }

        function deleteTask(taskId) {
            const taskRef = ref(database, 'tasks/' + taskId);
            remove(taskRef).then(() => {
                showAlert('Task deleted successfully!');
            }).catch((error) => {
                console.error("Error deleting task: ", error);
                showAlert('Error deleting task.');
            });
        }

        function editTask(taskId, text, username) {
            editingTaskId = taskId;
            editingTaskUsername = username; // Store the username of the task being edited
            document.getElementById('editInputTask').value = text;
        }

        function showAlert(message) {
            const alertPlaceholder = document.getElementById('alertPlaceholder');
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show';
            alert.role = 'alert';
            alert.innerHTML = message + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
            alertPlaceholder.appendChild(alert);

            // Automatically close the alert after 2 seconds
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }, 2000);
        }

        document.addEventListener('DOMContentLoaded', function () {
            const send_task_btn = document.getElementById('send-task');

            send_task_btn.addEventListener('click', function (event) {
                event.preventDefault();

                const username = document.getElementById('usernameSelect').value;
                const text = document.getElementById('inputTask').value;
                const date = document.getElementById('inputDate').value;

                if (username && text && date) {
                    writeTask(username, text, date);
                    showAlert('Task saved to Firebase!');
                    document.getElementById('inputTask').value = '';
                    document.getElementById('inputDate').value = '';
                } else {
                    showAlert('Please select a username, enter a task, and choose a date.');
                }
            });

            document.getElementById('saveEditBtn').addEventListener('click', function () {
                const text = document.getElementById('editInputTask').value;

                // Use the stored username of the task being edited
                writeTask(editingTaskUsername, text, new Date().toISOString().split('T')[0]);
                const editModal = new bootstrap.Modal(document.getElementById('editTaskModal'));
                editModal.hide();

                showAlert('Task updated successfully!');
            });

            loadUsernames();
            loadTasks();

            // Check user authentication and role
            redirectUserBasedOnRole();

            document.getElementById('filterSelect').addEventListener('change', function () {
                const filterUsername = this.value;
                loadTasks(filterUsername);
            });

            document.getElementById('tasks-list').addEventListener('click', function (event) {
                if (event.target.classList.contains('delete-btn')) {
                    const taskId = event.target.getAttribute('data-id');
                    if (confirm('Are you sure you want to delete this task?')) {
                        deleteTask(taskId);
                    }
                }
                if (event.target.classList.contains('edit-btn')) {
                    const taskId = event.target.getAttribute('data-id');
                    const text = event.target.getAttribute('data-text');
                    const username = event.target.getAttribute('data-username'); // Get the username of the task
                    editTask(taskId, text, username); // Pass the username to the edit function
                }
            });
        });
    </script>
</head>
<body class="bg-dark">

    <!-- Alert Placeholder -->
    <div id="alertPlaceholder"></div>

    <div class="container mt-4">
        <h1 class="text-center mb-4 text-light">Task Management</h1>
        <div id="taskManager" class="hidden">
            <div class="card">
                <div class="card-body">
                    <form>
                        <div class="mb-3">
                            <label for="usernameSelect" class="form-label">Select Username</label>
                            <select class="form-select" id="usernameSelect" required>
                                <option value="">Select a username</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="inputTask" class="form-label">Task</label>
                            <textarea class="form-control" id="inputTask" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="inputDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="inputDate" required>
                        </div>
                        <button id="send-task" type="submit" class="btn btn-primary btn-block">Send Task</button>
                    </form>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center m-2">
                <h3 class="text-light me-2">Tasks:</h3>
                <div class="d-flex justify-content-center align-items-center">
                    <label for="" class="text-light m-3">Filter :</label>
                    <select class="form-select w-auto" id="filterSelect">
                        <option value="">All Users</option>
                    </select>
                </div>
            </div>

            <div id="tasks-list" class="mb-4"></div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editTaskModalLabel">Edit Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editInputTask" class="form-label">Task</label>
                        <textarea class="form-control" id="editInputTask" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="saveEditBtn" class="btn btn-primary" data-bs-dismiss="modal">Save changes</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>

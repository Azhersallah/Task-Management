<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Tasks</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <style>
        body {
            color: #212529;
        }
        .profile-container {
            text-align: center;
            margin-bottom: 30px;
        }
        .profile-image {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #007bff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .welcome-message {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 10px;
        }
        .task-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .completed {
            text-decoration: line-through;
            color: rgba(128, 128, 128, 0.638) !important;
        }
        .logout-btn {
            margin-top: 20px;
        }
        input {
            border: solid 1px black !important;
        }
        .btn-full {
            width: 100%;
        }
        .loading {
            display: none; /* Initially hidden */
        }
        /* Alert styles */
        .alert {
            position: fixed;
            top: 20px;
            font-size: 12px;
            width: 100% !important;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1050; /* Ensure it's above other content */
            width: auto;
            max-width: 60%;
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCNGOAnTyQ-z91is5nku_vKQMIXMsjH3sg",
            authDomain: "ttaskk-a50e4.firebaseapp.com",
            databaseURL: "https://ttaskk-a50e4-default-rtdb.firebaseio.com/",
            projectId: "ttaskk-a50e4",
            storageBucket: "ttaskk-a50e4.appspot.com",
            messagingSenderId: "213200371465",
            appId: "1:213200371465:web:2cee76953abdc5d8049dd8",
            measurementId: "G-8J99HLPT61"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);
        const firestore = getFirestore(app);
        let currentUser = null;

        async function getUserData(uid) {
            const docRef = doc(firestore, 'users-uid', uid);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                return docSnap.data();
            } else {
                console.error("No such document!");
                return null;
            }
        }

        function displayTask(username, text, taskId, status, date) {
            const tasksList = document.getElementById('tasks-list');
            const taskCard = document.createElement('div');
            taskCard.classList.add('task-card');
            taskCard.innerHTML = `
                <div class="d-flex align-items-center mb-2 text-dark ">
                    <input type="checkbox" class="form-check-input me-2" aria-label="Checkbox for task" data-id="${taskId}" ${status ? 'checked' : ''} disabled>
                    <p class="text-start mb-0 ${status ? 'completed' : ''}">${text}</p>
                </div>
                <div class="text-muted">Date: ${new Date(date).toLocaleDateString()}</div>
                <div class="mt-2 d-flex justify-content-between">
                    <button class="btn btn-success btn-full me-1 complete-btn" data-id="${taskId}">Complete</button>
                    <button class="btn btn-warning btn-full ms-1 uncomplete-btn" data-id="${taskId}">Uncomplete</button>
                </div>
            `;
            tasksList.appendChild(taskCard);

            // Add event listener for buttons
            taskCard.querySelector('.complete-btn').addEventListener('click', function() {
                updateTaskStatus(taskId, true, username, text);
                showAlert("Task marked as completed!");
                taskCard.querySelector('input[type="checkbox"]').checked = true;
                taskCard.querySelector('p').classList.add('completed');
            });

            taskCard.querySelector('.uncomplete-btn').addEventListener('click', function() {
                updateTaskStatus(taskId, false, username, text);
                showAlert("Task marked as uncompleted!");
                taskCard.querySelector('input[type="checkbox"]').checked = false;
                taskCard.querySelector('p').classList.remove('completed');
            });
        }

        function updateTaskStatus(taskId, status, username, text) {
            const taskRef = ref(database, 'tasks/' + taskId);
            const currentDate = new Date().toISOString(); // Current date in ISO format
            set(taskRef, { 
                status: status, 
                username: username, 
                date: currentDate, 
                text: text 
            })
            .then(() => {
                console.log("Task updated successfully!");
            })
            .catch((error) => {
                console.error("Error updating task: ", error);
                showAlert("Error updating task.");
            });
        }

        function loadTasks(username) {
            const tasksRef = ref(database, 'tasks/');
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = 'block'; // Show loading indicator

            onValue(tasksRef, (snapshot) => {
                const tasksList = document.getElementById('tasks-list');
                tasksList.innerHTML = '';
                loadingIndicator.style.display = 'none'; // Hide loading indicator

                if (snapshot.exists()) {
                    const tasks = snapshot.val();
                    for (const taskId in tasks) {
                        const { username: taskUsername, text, status, date } = tasks[taskId];
                        if (taskUsername === username) {
                            displayTask(taskUsername, text, taskId, status, date);
                        }
                    }
                } else {
                    tasksList.innerHTML = '<p class="text-muted">No tasks available.</p>';
                }
            });
        }

        function logout() {
            signOut(auth).then(() => {
                window.location.href = 'login.html';
            }).catch((error) => {
                console.error("Error logging out: ", error);
                showAlert("Error logging out.");
            });
        }

        function confirmLogout() {
            const confirmation = confirm("Are you sure you want to log out?");
            if (confirmation) {
                logout();
            }
        }

        function showAlert(message) {
            const alertPlaceholder = document.getElementById('alertPlaceholder');
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show';
            alert.role = 'alert';
            alert.innerHTML = message + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
            alertPlaceholder.appendChild(alert);

            // Automatically close the alert after 3 seconds
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', function () {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    const userData = await getUserData(user.uid);
                    if (userData) {
                        document.getElementById('welcomeMessage').textContent = userData.username;

                        // Set profile image from Firestore
                        if (userData.urlpic) {
                            document.querySelector('.profile-image').src = userData.urlpic;
                        } else {
                            // Fallback image if urlpic is not set
                            document.querySelector('.profile-image').src = "https://via.placeholder.com/120"; // Default placeholder image
                        }

                        loadTasks(userData.username);
                    } else {
                        console.error("User data not found!");
                        showAlert("Error loading user data.");
                    }
                } else {
                    window.location.href = 'login.html';
                }
            });

            // Add logout button event listener
            document.getElementById('logoutBtn').addEventListener('click', confirmLogout);
        });
    </script>
</head>
<body class="bg-dark text-light">

    <!-- Alert Placeholder -->
    <div id="alertPlaceholder"></div>
    
    <!-- Loading Indicator -->
    
    <div class="container mt-5">
        <div class="profile-container">
            <img src="https://via.placeholder.com/120" alt="Profile Image" class="profile-image mb-3">
            <h2 class="welcome-message" id="welcomeMessage"></h2>
            <div class="task-list mt-4" id="tasks-list"></div>
            <div id="loadingIndicator" class="loading text-light">Loading tasks...</div>
            <div class="w-full d-flex">
                <button id="logoutBtn" class="btn btn-danger ">Log Out</button>
            </div>
        </div>
    </div>

</body>
</html>
